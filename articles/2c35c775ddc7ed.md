---
title: "Cloud SQL Enterprise Plusのメンテナンスはどのように実現されているか"
emoji: "🐈"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["gcp", "cloudsql"]
published: false
publication_name: "google_cloud_jp"
---
## はじめに

 Cloud SQLには[Enterprise Plusというエディション](https://cloud.google.com/blog/ja/products/databases/announcing-the-cloud-sql-enterprise-plus-edition-for-mysql-and-postgresql)があります。その特徴の1つとして計画メンテナンス時のダウンタイムの短さがあります。本稿ではこのメンテナンス時間の短縮がどのような仕組みで実現されているかを解説します。

 Cloud SQL Enterprise Plusを使うだけであればメンテナンス時のダウンタイムが短いのだなという理解でも十分です。その中で実際に何が行われているか興味がある方のための解説です。
 このメンテナンスの方式のことを「[ダウンタイムがほぼゼロの計画的メンテナンス](https://cloud.google.com/sql/docs/mysql/maintenance?hl=ja#nearzero)（Near-zero downtime planned maintenance）」と呼んでいます。少々長いので以降はニアゼロダウンタイムと記載します。

## 仕組みの詳細

以降の説明はCloud SQL Enterprise Plus for MySQLを前提にします。データベースエンジンでの用語などの違いはありますが、基本的にはPostgreSQLでも同様のプロセスで実行されます。

ニアゼロダウンタイムはHA構成が前提となっているので、構成要素は大きく以下の通りです。

- プライマリ：HA構成のアクティブ側のVM
- スタンバイ：HA構成のスタンバイ側のVM
- [リージョナルPD](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/regional-pd?hl=ja)（Regional Persistent Disk）：プライマリとスタンバイで共有されているゾーン間で冗長構成となっているブロックストレージ、いわゆるディスクデバイス
- スタティックIPアドレス：DBエンジンにアクセスするためのIPアドレスで、プライマリを指しています

### 準備

このステップではストレージも含めて、既存のインスタンスの構成と同じ構成を再現します。

新たに作られるプライマリとスタンバイはそれぞれシャドープライマリ、シャドースタンバイと呼びます。ストレージはメンテナンス対象の内容を複製します。ハードウェアなどの構成を行ったあとにプライマリとシャドープライマリの間でバイナリログレプリケーションを構成します。これによりシャドースタンバイは複製により作られた以降の更新内容も受け取れます。
シャドープライマリはこの時点ではユーザーからアクセス可能なIPアドレスを持っていません。

このステップは言い換えると外からはアクセスできないリードレプリカを作成する動作とも言えます。

### シャドープライマリへのメンテナンスの適用

一連の仕組みは何らかのメンテナンスを適用することであるため、この時点でシャドープライマリを対象にメンテナンスを実行します。
データベースエンジンの更新など適用後にサービスの中断を必要とする場合もありますが、対象はアクセスできないシャドープライマリであるためサービスの中断はありません。

メンテナンス適用の復帰後、レプリケーションにより再起動中の更新差分も受け取ってプライマリとシャドープライマリの内容は追いついた状態となります。

### サービスの中断

このステップが実際のサービスの中断となります。先のステップの完了後でレプリケーションが追いついていることを確認してから実行されます。

プライマリで新規のコネクションの受付を止めて、スタティックIPアドレスをプライマリからシャドープライマリに切り替えます。また、シャドープライマリとプライマリ間でのレプリケーションを停止します。これによりシャドープライマリが新たなプライマリへと昇格されます。

このステップは通常、1秒から2秒程度です。

### 片付け

シャドープライマリが昇格したため、元のプライマリは用済みとなるため不要となったリソースの順次片付けが行われます。

## よくある疑問点

### メンテナンスの前提条件

この方式が適用できる前提条件の各項目については、マニュアルの該当箇所をご覧ください。

![前提条件と制約](https://cloud.google.com/sql/docs/mysql/maintenance?hl=ja#prerequisites_and_constraints)

ここではなぜそのような前提があるのかを解説します。前述の仕組みを理解するとこのメンテナンスの前提条件や制約は理解しやすいと思います。

前提条件として求められているパラメーターは安全なバイナリログレプリケーションで求められる内容と一致します。これはプライマリとシャドープライマリの間でバイナリログレプリケーションを実行しているためです。
メンテナンス対象のインスタンスが外部のリードレプリカを持っている場合、メンテナンスの前後でレプリケーションも追従する必要があるため、GTIDによる自動ポジショニングが有効であることも条件です。メンテナンス中にログが二重に出るタイミングがある点やSID（Server ID）が切り替わるという理由も、メンテナンス時にプライマリとシャドープライマリでVM間での切り替わりがあることで説明できます。

### 対象となるメンテナンス

- OSへのパッチ適用
- DBエンジンのマイナーバージョンアップ
- インスタンスサイズのスケールアップ

ニアゼロダウンタイムの解説から少し外れますが、Cloud SQLではMySQL 8.0からマイナーバージョンを自動的に更新しなくなりました。MySQL 5.7以前ではマイナーバージョンを自動的に更新していましたので、以前のバージョンの動作で慣れている方はご注意ください。

### メンテナンスの全体の時間が長いのはどうして？

仕組みの解説の通り、ニアゼロダウンタイムのメンテナンスはダウンタイムを短くするため、事前に追加のリソースを使い準備期間を長めにとります。そのためメンテナンス適用本体が数十秒で終わる内容であっても、事前の準備と片付けも含めると数分程度と傾向があります。

### メンテナンス後のパフォーマンス

メンテナンスの前後で異なるVMに切り替わるため、メモリ上のキャッシュがクリアされます。そのためメモリ上のキャッシュが再び温まるまでストレージへのアクセスが増える可能性があります。

一方でストレージについてもメンテナンス前後で新しいストレージが使用されますが、ストレージとして使っているリージョナルPDは複製後の**初回アクセス時にレイテンシが高くなるといった症状は一般的に発生しません。そのためストレージの性能についてはメンテンナンス前後で同程度であることが期待されます**。

### ダウンタイムはメンテナンス内容によって変化するか？

上記で説明した通り、ダウンタイムはメンテナンスの適用の後で実行されます、そのためメンテナンスの内容はダウンタイムとはほぼ関連しないと思われます。
ただし、ダウンタイム以外も含めた全体の適用時間は内容によって多少の長短が発生する可能性があります。

### 通常のメンテナンスとニアゼロダウンタイムの違い

Enterprise Plus以前から使われている通常のメンテナンスでもダウンタイムを短くする努力が払われていました。具体的には自動フェイルオーバーの仕組みを使っています。スタンバイのVMを作成し、そちらへメンテナンスを適用しフェイルオーバーします。

https://cloud.google.com/sql/docs/mysql/maintenance?hl=ja#how-maintenance-works

ニアゼロダウンタイムではストレージも含めて構成を複製後に切り替えます。この方式のメリットはデータベースエンジンのシャットダウンとストレージの引き継ぎを行うステップを省略できる点があります。

## 参考リンク
- https://product.st.inc/entry/2023/11/27/100900
