---
title: "Spanner ã« UPSERT(INSERT OR UPDATE) ãŒæ¥ã¾ã—ãŸ"
emoji: "ðŸ‘¨â€ðŸ”§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["spanner"]
published: false
---
# æ¦‚è¦
RDBMS ã‚’ä½¿ã†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã‚ˆãã€Œã“ã®ãƒ—ãƒ©ã‚¤ãƒžãƒªã‚­ãƒ¼ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯å­˜åœ¨ã™ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‘ã©ã€å­˜åœ¨ã—ãŸå ´åˆã¯æ›´æ–°(UPDATE)ã—ã¦ã€ã—ãªã‹ã£ãŸå ´åˆã«ã¯è¿½è¨˜(INSERT)ã—ã¦æ¬²ã—ã„ã€ã¨ã„ã†å‡¦ç†ãŒç™ºç”Ÿã—ã¾ã™ã€‚
ã“ã®ã‚ˆã†ãªå‡¦ç†ã¯ç´ ç›´ã«å®Ÿè£…ã™ã‚‹å ´åˆã«ã¯è©²å½“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ SELECT ã§å­˜åœ¨ç¢ºèªã‚’è¡Œã„ã€ãã®å¾Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ SELECT ã‚’è¡Œã£ã¦å­˜åœ¨ç¢ºèªã‚’ã—ã¦ã‹ã‚‰ãã®çµæžœã§ UPDATE ã‹ INSERT ã«å‡¦ç†ã‚’åˆ†å²ã•ã›ã‚‹æ–¹æ³•ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ä¸€æ–¹ã§ã€ã“ã®ã‚ˆã†ãªå‡¦ç†ã«å¯¾å¿œã™ã‚‹ãŸã‚ã« SQL æ–‡ã®ãƒ¬ãƒ™ãƒ«ã§å¯¾å¿œã—ã¦ã„ã‚‹ RDBMS ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ãªå‡¦ç†ã¯ UPSERT ã¨ã„ã†åç§°ã§å‘¼ã°ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚

å…·ä½“çš„ãªå®Ÿè£…ä¾‹ã¨ã—ã¦ã¯ SQLite ã® [UPSERT](https://www.sqlite.org/lang_upsert.html)ã€PostgreSQL ã® INSERT ã® [ON CONFLICT DO UPDATE](https://www.postgresql.jp/document/15/html/sql-insert.html#SQL-ON-CONFLICT)ã‚„ MySQL ã® [INSERT ... ON DUPLICATE UPDATE](https://dev.mysql.com/doc/refman/8.0/ja/insert-on-duplicate.html)ãŒãã®ä¾‹ã§ã™ã€‚

Spanner ã¯2023å¹´1æœˆ23æ—¥ã®æ©Ÿèƒ½è¿½åŠ ã•ã‚Œã‚‹ã¾ã§ã¯ **DML ã§ã® UPSERT** ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã§ã—ãŸãŒã€INSERT OR UPDATE ã«å¯¾å¿œã—ãŸã“ã¨ã§ UPSERT ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ RDBMS ã‹ã‚‰ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç§»è¡ŒãŒå®¹æ˜“ã«ãªã‚Šã¾ã—ãŸã€‚

# ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹ insertOrUpdate
Spanner ã¯ SQL ã® DML(INSERT/UPDATE/DELETE)ã«ã‚ˆã‚‹æ›´æ–°ä»¥å¤–ã«ã€[ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³(Mutation)](https://cloud.google.com/spanner/docs/modify-mutation-api?hl=ja)ã¨ã„ã†ã‚ˆã‚Šä½Žãƒ¬ã‚¤ãƒ¤ãƒ¼ã® API ã«ã‚ˆã‚Šæ›´æ–°ãªã©ã‚’è¡Œã†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚
ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹æ›´æ–°ã§ã¯ä»Šå›žã®å¤‰æ›´ä»¥å‰ã‹ã‚‰ [insertOrUpdate](https://cloud.google.com/spanner/docs/reference/rest/v1/Mutation#FIELDS.insert_or_update) ãŒåˆ©ç”¨å¯èƒ½ã§ã—ãŸã€‚ã“ã®å‡¦ç†ã¯åå‰ã®é€šã‚Šã€UPSERT ç›¸å½“ã®æ©Ÿèƒ½ã‚’å®Ÿç¾ã§ãã‚‹ã‚‚ã®ã§ã™ã€‚å„è¨€èªžã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ã‚‚å®Ÿè¡ŒãŒå¯èƒ½ã§ã™([Goã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã®ä¾‹](https://pkg.go.dev/cloud.google.com/go/spanner#InsertOrUpdate))ã€‚

ã“ã®ãŸã‚ã€UPSERT ãŒå¿…è¦ãªå ´åˆã«ã€ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹æ›´æ–°ã‚’è¡Œã†æ–¹æ³•ãŒã‚ã‚Šã¾ã—ãŸã€‚åŒä¸€ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã—ã¦ DML ã¨ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½µç”¨ã¯åˆ©ç”¨å¯èƒ½ã§ã™ãŒã€[åŒä¸€ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã¯æ··åœ¨ã•ã›ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“](https://cloud.google.com/spanner/docs/dml-versus-mutations?hl=ja#best_practice_-_avoid_mixing_dml_and_mutation_in_the_same_transaction)ã€‚ãã®ãŸã‚ã€ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹ InsertOrUpdate ã‚’åˆ©ç”¨ã—ãŸã„å ´åˆã¯ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã§ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

# INSERT OR UPDATE
[2023å¹´1æœˆ23æ—¥ã®ãƒªãƒªãƒ¼ã‚¹](https://cloud.google.com/spanner/docs/release-notes?hl=ja#January_23_2024)ã«ãŠã„ã¦ Google æ¨™æº– SQL ã§ [INSERT OR UPDATE](https://cloud.google.com/spanner/docs/reference/standard-sql/dml-syntax#insert-or-update) ã¨ [INSERT OR IGNORE](https://cloud.google.com/spanner/docs/reference/standard-sql/dml-syntax#insert-ignore) ã«å¯¾å¿œã—ã¾ã—ãŸã€‚PostgreSQL äº’æ› SQL ã§ã¯ PostgreSQL ã¨åŒæ§˜ã« INSERT æ–‡ã« ON CONFLICT DO UPDATE SET å¥ã‚’ã¤ã‘ã‚‹æ§‹æ–‡ã§åŒæ§˜ã®æ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€å¾“æ¥ã¯ MySQL ã‚„ PostgreSQL ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç§»æ¤ã™ã‚‹éš›ã« UPSERT éƒ¨åˆ†ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†å²ã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã‹ã€ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ä»Šå›žã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ã‚ˆã‚Šã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆã«å®Ÿè£…ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

## å®Ÿè¡Œä¾‹
ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã¨äº‹å‰ãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã‚’å‰æã«ã—ã¦ã„ã¾ã™ã€‚
```sql
spanner> show create table Singers\G
*************************** 1. row ***************************
       Table: Singers
Create Table: CREATE TABLE Singers (
  SingerId INT64 NOT NULL,
  FirstName STRING(1024),
  LastName STRING(1024),
  SingerInfo BYTES(MAX),
) PRIMARY KEY(SingerId)
1 rows in set (0.49 sec)

spanner> select * from Singers;
+----------+-----------+----------+------------+
| SingerId | FirstName | LastName | SingerInfo |
+----------+-----------+----------+------------+
| 1        | Marc      | Richards | NULL       |
| 2        | Catalina  | Smith    | NULL       |
| 3        | Alice     | Trentor  | NULL       |
+----------+-----------+----------+------------+
3 rows in set (3.78 msecs)
```

ã“ã“ã«æ–°ãŸã«ãƒ—ãƒ©ã‚¤ãƒžãƒªã‚­ãƒ¼ãŒ `SingerId=4` ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿½è¨˜ã—ã¾ã™ã€‚ç¶šã‘ã¦ã€åŒã˜ãƒ—ãƒ©ã‚¤ãƒžãƒªã‚­ãƒ¼ã‚’æŒ‡å®šã—ã¦ INSERT OR UPDATEã‚’å®Ÿè¡Œã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‰ãšå®Œäº†ã—ã¾ã™ã€‚
```sql
spanner> INSERT OR UPDATE Singers (SingerId, FirstName, LastName) VALUES (4, 'Lea', 'Martin');
Query OK, 1 rows affected (0.08 sec)

spanner> select * from Singers;
+----------+-----------+----------+------------+
| SingerId | FirstName | LastName | SingerInfo |
+----------+-----------+----------+------------+
| 1        | Marc      | Richards | NULL       |
| 2        | Catalina  | Smith    | NULL       |
| 3        | Alice     | Trentor  | NULL       |
| 4        | Lea       | Martin   | NULL       |
+----------+-----------+----------+------------+
4 rows in set (8.46 msecs)

spanner> INSERT OR UPDATE Singers (SingerId, FirstName, LastName) VALUES (4, 'Lea', 'Martin');
Query OK, 1 rows affected (0.03 sec)

spanner> select * from Singers;
+----------+-----------+----------+------------+
| SingerId | FirstName | LastName | SingerInfo |
+----------+-----------+----------+------------+
| 1        | Marc      | Richards | NULL       |
| 2        | Catalina  | Smith    | NULL       |
| 3        | Alice     | Trentor  | NULL       |
| 4        | Lea       | Martin   | NULL       |
+----------+-----------+----------+------------+
4 rows in set (1.39 msecs)
```
INSERT OR UPDATE ãªã®ã§ã€ãƒ—ãƒ©ã‚¤ãƒžãƒªã‚­ãƒ¼ä»¥å¤–ã®ã‚«ãƒ©ãƒ (FirstNameã¨LastName)ã«å®Ÿè¡Œå‰ã¨é•ã†å†…å®¹ã‚’æŒ‡å®šã™ã‚‹ã¨å½“ç„¶æ›´æ–°(UPDATE)ã•ã‚Œã¾ã™ã€‚
```sql
spanner> INSERT OR UPDATE Singers (SingerId, FirstName, LastName) VALUES (4, 'Nick', 'Porter');
Query OK, 1 rows affected (0.09 sec)

spanner> select * from Singers where SingerId=4;
+----------+-----------+----------+------------+
| SingerId | FirstName | LastName | SingerInfo |
+----------+-----------+----------+------------+
| 4        | Nick      | Porter   | NULL       |
+----------+-----------+----------+------------+
1 rows in set (1.38 msecs)
```

# INSERT OR IGNORE
INSERT  OR UPDATE ã«æ¯”ã¹ã‚‹ã¨ä½¿ã„æ‰€ãŒã‚„ã‚„å°‘ãªã„ã§ã™ãŒã€INSERT OR IGNORE ã¨ã„ã†æ§‹æ–‡ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã¡ã‚‰ã¯ã™ã§ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã«ã¯è¿½è¨˜ã‚‚æ›´æ–°ã‚‚ã—ãªã„ã¨ã„ã†å‹•ä½œã¨ãªã‚Šã¾ã™ã€‚

## å®Ÿè¡Œä¾‹
ã™ã§ã«åŒã˜ãƒ—ãƒ©ã‚¤ãƒžãƒªã‚­ãƒ¼ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹çŠ¶æ…‹ã§ã€INSERT OR IGNORE ã§ç•°ãªã‚‹å€¤ã‚’è¿½è¨˜ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã¨ã¯ãªã‚‰ãšã€æ›´æ–°ã‚‚ã•ã‚Œãªã„ã¨ã„ã†å‹•ä½œã¨ãªã‚Šã¾ã™ã€‚
```sql
spanner> select * from Singers where SingerId=4;
+----------+-----------+----------+------------+
| SingerId | FirstName | LastName | SingerInfo |
+----------+-----------+----------+------------+
| 4        | Nick      | Porter   | NULL       |
+----------+-----------+----------+------------+
1 rows in set (4.02 msecs)

spanner> INSERT OR IGNORE Singers (SingerId, FirstName, LastName) VALUES (4, 'Nick', 'Porter');
Query OK, 0 rows affected (0.05 sec)

spanner> select * from Singers where SingerId=4;
+----------+-----------+----------+------------+
| SingerId | FirstName | LastName | SingerInfo |
+----------+-----------+----------+------------+
| 4        | Nick      | Porter   | NULL       |
+----------+-----------+----------+------------+
1 rows in set (4.24 msecs)
```