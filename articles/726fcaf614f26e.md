---
title: "Cloud Spanner ã®å®Ÿè¡Œè¨ˆç”»ã‚’èª­ã¿è§£ã"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["cloudspanner","spanner","gcp"]
published: false
---
# æ¦‚è¦
Cloud Spanner ã¯ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã™ã‚‹åˆ†æ•£ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ã®ç‰¹æ€§ãŒã‚ã‚Šã¾ã™ãŒã€ä¸€èˆ¬çš„ãª RDBMS ã¨åŒã˜ã SQL ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
SQL ã®å®Ÿè¡Œæ™‚ã«ã¯å®Ÿè¡Œè¨ˆç”»ã‚’ç«‹ã¦ã¦ã€å®Ÿãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã„ã¾ã™ã€‚
å®Ÿè¡Œè¨ˆç”»ã®å†…å®¹ã¯åˆ†æ•£ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç‰¹æœ‰ã®æ¦‚å¿µã‚‚å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒã€åŸºæœ¬çš„ãªã‚³ãƒ³ã‚»ãƒ—ãƒˆã¯ RDBMS ã¨å…±é€šã™ã‚‹éƒ¨åˆ†ã‚‚å¤šãã‚ã‚Šã¾ã™ã€‚
æœ¬è¨˜äº‹ã§ã¯ Cloud Spanner ã§ã®ã‚¯ã‚¨ãƒªãƒ¼ã®å®Ÿè¡Œè¨ˆç”»ã«ã¤ã„ã¦ã®å®Ÿä¾‹ã‚’ã‚‚ã¨ã«ãã®å†…å®¹ã‚’èª­ã¿è§£ãã¾ã™ã€‚

å¯¾è±¡ã¨ã™ã‚‹ã‚¹ã‚­ãƒ¼ãƒåŠã³ã‚¯ã‚¨ãƒªãƒ¼ã¯ MySQL ã‚’å¯¾è±¡ã«ã—ãŸæ¬¡ã®è¨˜äº‹ã®å†…å®¹ã‚’ Cloud Spanner å‘ã‘ã«èª­ã¿æ›ãˆãŸç‰©ã‚’ä½¿ç”¨ã„ãŸã—ã¾ã—ãŸã€‚
[MySQLã§Nested Loopãªã‚¯ã‚¨ãƒªã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã©ã†è¾¿ã£ã¦ã„ã‚‹ã‹ - $shibayu36->blog;](https://blog.shibayu36.org/entry/2023/07/18/170000)
ç´ æ™´ã‚‰ã—ã„è¨˜äº‹ã‚’å…¬é–‹ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚

Cloud Spanner ã¯ Google æ¨™æº– SQL ã¨ PostgreSQL äº’æ›ã®äºŒé€šã‚Šã® SQL ãƒ¢ãƒ¼ãƒ‰ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¯ã«ä½¿ã„åˆ†ã‘ã‚‰ã‚Œã¾ã™ãŒã€æœ¬ç¨¿ã§ã¯ Google æ¨™æº– SQL ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚

# ã‚¹ã‚­ãƒ¼ãƒ
ã‚¹ã‚­ãƒ¼ãƒã«é–¢ã—ã¦ã¯ã€å…ƒè¨˜äº‹ã®å®šç¾©ã‹ã‚‰å¤‰æ›´ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

ä¸»ã‚­ãƒ¼ã¯å…ƒã®å®šç¾©ã§ã¯ INTEGER ã® AUTO_INCREMENT ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ãŒã€UUID ã«å¤‰æ›´ã—ãŸãŸã‚å‹ã«ã¤ã„ã¦ã‚‚ STRING(36) ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚

Cloud Spanner ã§ã¯[ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–](https://cloud.google.com/spanner/docs/schema-and-data-model?hl=ja#create-interleaved-tables)ã¨ã„ã†æ¦‚å¿µãŒã‚ã‚Šã€ãƒ†ãƒ¼ãƒ–ãƒ«é–“ã§è¦ªå­é–¢ä¿‚ãŒå®šç¾©ã§ãã¾ã™ã€‚
å­ãƒ†ãƒ¼ãƒ–ãƒ«ã¯è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ã®é–¢é€£ã™ã‚‹è¡Œã¨é€£ç¶šã—ãŸå ´æ‰€ã«é…ç½®ã•ã‚Œã‚‹ã“ã¨ã§ã€åŠ¹ç‡çš„ãªã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

ä»Šå›ã®å ´åˆã€users ã‚’è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦ã€follows ã¨ posts ã¯ä¸¡æ–¹ã‚’å­ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¾ã—ãŸã€‚
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã®å­ãƒ†ãƒ¼ãƒ–ãƒ«ã¯è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸»ã‚­ãƒ¼(user_id)ã‚’å…ˆé ­ã«ã—ãŸè¤‡åˆä¸»ã‚­ãƒ¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã®å®šç¾©ã«ã‚ˆã‚Šã€ã‚ã‚‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§(follows)ã¨ãƒã‚¹ãƒˆã—ãŸè¨˜äº‹(posts)ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªä½“ã®æƒ…å ±ã«ç¶šã„ã¦ç‰©ç†çš„ã«ã¾ã¨ã¾ã£ã¦é…ç½®ã•ã‚Œã¾ã™ã€‚

```sql
CREATE TABLE `users` (
        `user_id` STRING(36) NOT NULL,
        `name` STRING(100) NOT NULL,
) PRIMARY KEY (`user_id`);

CREATE TABLE `follows` (
        `user_id` STRING(36) NOT NULL,
        `followee_id` STRING(36) NOT NULL,
) PRIMARY KEY (user_id, followee_id),
INTERLEAVE IN PARENT users ON DELETE CASCADE;

CREATE TABLE `posts` (
        `user_id` STRING(36) NOT NULL,
        `post_id` STRING(36) NOT NULL,
        `body` STRING(MAX) NOT NULL,
        `posted_at` TIMESTAMP NOT NULL,
        `deleted` BOOL NOT NULL,
) PRIMARY KEY (`user_id`, post_id),
INTERLEAVE IN PARENT users ON DELETE CASCADE;

CREATE INDEX `idx_user_id_posted_at` ON `posts` (`user_id`, `posted_at` ), INTERLEAVE IN users;

ALTER TABLE `follows` ADD FOREIGN KEY (followee_id) REFERENCES `users` (user_id);
```
# ã‚¯ã‚¨ãƒª
ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´ã«ä¼´ã„ä¸€éƒ¨ã®ã‚«ãƒ©ãƒ åã¨å‹ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚ãã®ãŸã‚ã‚¯ã‚¨ãƒªãƒ¼ä¸­ã§ã®ã‚«ãƒ©ãƒ åã¨æ¡ä»¶å¥ã®å€¤ã‚’ã‚’å¤‰æ›´ã—ã¾ã—ãŸãŒã€ãã‚Œä»¥å¤–ã®éƒ¨åˆ†ã«ã¤ã„ã¦ã¯ãã®ã¾ã¾å®Ÿè¡Œå¯èƒ½ã§ã—ãŸã€‚

```sql
SELECT
  posts.*
FROM
  posts
JOIN
  follows
ON
  posts.user_id = follows.followee_id
WHERE
  follows.user_id = '0001c88e-3d48-486e-8b61-cb9bcb497430'
  AND posts.deleted = FALSE
  AND posts.posted_at <= '2023-07-16 02:41:52.000'
ORDER BY
  posts.posted_at DESC
LIMIT
  20;
```
ä»¥é™ã®å†…å®¹ã¯ã“ã®ã‚¯ã‚¨ãƒªãƒ¼ã«ã¤ã„ã¦ã®å®Ÿè¡Œè¨ˆç”»ã‚’èª­ã¿è§£ãã¾ã™ã€‚

# å®Ÿè¡Œè¨ˆç”»ã®å–å¾—æ–¹æ³•
Cloud Spanner ã®å®Ÿè¡Œè¨ˆç”»ã‚’å–å¾—ã™ã‚‹ä¸»ãªæ–¹æ³•ã¯ã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¾ãŸã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰å–å¾—å¯èƒ½ã§ã™ã€‚
å®šæœŸçš„ãªå–å¾—ã§ã‚ã‚Œã°ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œã‚‹ã“ã¨ã‚‚æœ‰åŠ¹ã§ã™ãŒã€[spanner-cli](https://github.com/cloudspannerecosystem/spanner-cli) ã§å¯¾è©±çš„ã«ã‚‚å–å¾—å¯èƒ½ã§ã™ã€‚

å®Ÿè¡Œè¨ˆç”»ã®è©³ç´°ã‚’ JSON å½¢å¼ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ gcloud ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰å–å¾—å¯èƒ½ãªä»–ã€ã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå¯èƒ½ã§ã™ã€‚JSON å½¢å¼ã¯æƒ…å ±é‡ãŒå¤šã„ã‚‚ã®ã®ã€äººé–“ãŒç›´æ¥èª­ã‚€ã«ã¯ã¤ã‚‰ã„ãŸã‚ apstndb ã•ã‚“ä½œæˆã® [spannerplanviz](https://github.com/apstndb/spannerplanviz) ã§å¯è¦–åŒ–ã•ã‚Œã‚‹ã¨ä¾¿åˆ©ã§ã™ã€‚

# å®Ÿè¡Œè¨ˆç”»ã®è©³ç´°
## ã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å–å¾—ã—ãŸå®Ÿè¡Œè¨ˆç”»
ã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚¯ã‚¨ãƒªãƒ¼ã‚’å®Ÿè¡Œã—ã€ãã®ã€Œèª¬æ˜ã€ã‚¿ãƒ–ã‚’è¦‹ã‚‹ã¨å®Ÿè¡Œè¨ˆç”»ã‚’ã‚°ãƒ©ãƒ•åŒ–ã—ãŸã‚‚ã®ãŒè¦‹ãˆã¾ã™ã€‚

![](/images/plan_on_console.png)

## spanner-cli ã‹ã‚‰å–å¾—ã—ãŸå®Ÿè¡Œè¨ˆç”»
spanner-cli ã‹ã‚‰åŒã˜ã‚¯ã‚¨ãƒªãƒ¼ã«ã¤ã„ã¦ EXPLAIN ANALYZE(å®Ÿè¡Œè¨ˆç”»ã¨å®Ÿéš›ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å–å¾—)ã‚’è¡Œã£ãŸçµæœãŒä»¥ä¸‹ã§ã™ã€‚
```
spanner> EXPLAIN ANALYZE SELECT
      ->   posts.*
      -> FROM
      ->   posts
      -> JOIN
      ->   follows
      -> ON
      ->   posts.user_id = follows.followee_id
      -> WHERE
      ->   follows.user_id = '0001c88e-3d48-486e-8b61-cb9bcb497430'
      ->   AND posts.deleted = FALSE
      ->   AND posts.posted_at <= '2023-07-16 02:41:52.000'
      -> ORDER BY
      ->   posts.posted_at DESC
      -> LIMIT
      ->   20;
+-----+--------------------------------------------------------------------------+---------------+------------+---------------+
| ID  | Query_Execution_Plan                                                     | Rows_Returned | Executions | Total_Latency |
+-----+--------------------------------------------------------------------------+---------------+------------+---------------+
|  *0 | Distributed Union                                                        | 20            | 1          | 427.6 msecs   |
|   1 | +- Serialize Result                                                      | 20            | 1          | 427.58 msecs  |
|   2 |    +- Global Sort Limit                                                  | 20            | 1          | 427.57 msecs  |
|  *3 |       +- Distributed Cross Apply                                         | 60            | 1          | 427.51 msecs  |
|   4 |          +- [Input] Create Batch                                         |               |            |               |
|   5 |          |  +- Local Distributed Union                                   | 1000          | 1          | 0.84 msecs    |
|   6 |          |     +- Compute Struct                                         | 1000          | 1          | 0.78 msecs    |
|  *7 |          |        +- Filter Scan                                         |               |            |               |
|   8 |          |           +- Table Scan (Table: follows, scan_method: Scalar) | 1000          | 1          | 0.55 msecs    |
|  17 |          +- [Map] Local Sort Limit                                       | 60            | 3          | 861.26 msecs  |
|  18 |             +- Cross Apply                                               | 869261        | 3          | 818.59 msecs  |
|  19 |                +- [Input] KeyRangeAccumulator                            |               |            |               |
|  20 |                |  +- Batch Scan (Batch: $v2, scan_method: Scalar)        |               |            |               |
|  22 |                +- [Map] Local Distributed Union                          | 869261        | 1000       | 771.92 msecs  |
| *23 |                   +- Filter Scan                                         |               |            |               |
|  24 |                      +- Table Scan (Table: posts, scan_method: Scalar)   | 869261        | 1000       | 732.75 msecs  |
+-----+--------------------------------------------------------------------------+---------------+------------+---------------+
Predicates(identified by ID):
  0: Split Range: ($user_id_1 = '0001c88e-3d48-486e-8b61-cb9bcb497430')
  3: Split Range: ($user_id = $followee_id)
  7: Seek Condition: ($user_id_1 = '0001c88e-3d48-486e-8b61-cb9bcb497430')
 23: Seek Condition: ($user_id = $batched_followee_id)
     Residual Condition: (($deleted = false) AND ($posted_at <= timestamp (2023-07-16 02:41:52-07:00)))

20 rows in set (442.46 msecs)
timestamp:            2023-08-04T17:48:20.068238+09:00
cpu time:             913.62 msecs
rows scanned:         1001000 rows
deleted rows scanned: 0 rows
optimizer version:    5
optimizer statistics: auto_20230803_00_47_06UTC
```

## JSON å½¢å¼ã®å®Ÿè¡Œè¨ˆç”»ã‚’ã‚°ãƒ©ãƒ•åŒ–ã—ãŸã‚‚ã®
JSON å½¢å¼ã§å–å¾—ã—ãŸå®Ÿè¡Œè¨ˆç”»ã‚’ spannerplanviz ã§å¯è¦–åŒ–ã—ãŸã‚‚ã®ãŒä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![](/images/plan_graph.png)

# å®Ÿè¡Œè¨ˆç”»ã®èª­ã¿è§£ã
å®Ÿè¡Œè¨ˆç”»ã¯ä¸€è¦‹ã—ãŸã¨ã“ã‚éå¸¸ã«è¤‡é›‘ã«è¦‹ãˆã¾ã™ãŒã€å„ã‚¹ãƒ†ãƒƒãƒ—ãŒç´°ã‹ãè¡¨ç¾ã•ã‚Œã¦ã„ã‚‹ã ã‘ã§ä¸»è¦ãªå‡¦ç†ã¯ãã‚Œã»ã©è¤‡é›‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

å®Ÿè¡Œè¨ˆç”»ã¯å¤§ããåˆ†ã‘ã¦3ã¤ã®ãƒ‘ãƒ¼ãƒˆã‹ã‚‰æ§‹æˆã•ã‚Œã‚‹ã®ã§ã€

## 

# å‚è€ƒè³‡æ–™
https://engineering.mercari.com/blog/entry/20201210-cloud-spanner-query-plan/
https://cloud.google.com/spanner/docs/tune-query-with-visualizer?hl=ja
