---
title: "Cloud Spanner ã®å®Ÿè¡Œè¨ˆç”»ã‚’èª­ã¿è§£ã"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["cloudspanner", "gcp"]
publication_name: "google_cloud_jp"
published: false
---
# ã¯ã˜ã‚ã«
Cloud Spanner (ä»¥ä¸‹ã€Spanner)ã¯ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã™ã‚‹åˆ†æ•£ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ã®ç‰¹æ€§ãŒã‚ã‚Šã¾ã™ãŒã€ä¸€èˆ¬çš„ãª RDBMS ã¨åŒã˜ã SQL ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚SQL ã®å®Ÿè¡Œæ™‚ã«ã¯å®Ÿè¡Œè¨ˆç”»ã‚’ç«‹ã¦ã¦ã€å®Ÿãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã„ã¾ã™ã€‚å®Ÿè¡Œè¨ˆç”»ã®å†…å®¹ã¯åˆ†æ•£ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç‰¹æœ‰ã®æ¦‚å¿µã‚‚å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒã€åŸºæœ¬çš„ãªã‚³ãƒ³ã‚»ãƒ—ãƒˆã¯ RDBMS ã¨å…±é€šã™ã‚‹éƒ¨åˆ†ã‚‚å¤šãã‚ã‚Šã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ Spanner ã§ã®ã‚¯ã‚¨ãƒªãƒ¼ã®å®Ÿè¡Œè¨ˆç”»ã«ã¤ã„ã¦ã®å®Ÿä¾‹ã‚’ã‚‚ã¨ã«ãã®å†…å®¹ã‚’èª­ã¿è§£ãã¾ã™ã€‚

å¯¾è±¡ã¨ã™ã‚‹ã‚¹ã‚­ãƒ¼ãƒåŠã³ã‚¯ã‚¨ãƒªãƒ¼ã¯ MySQL ã‚’å¯¾è±¡ã«ã—ãŸæ¬¡ã®è¨˜äº‹ã®å†…å®¹ã‚’ Spanner å‘ã‘ã«èª­ã¿æ›ãˆãŸç‰©ã‚’ä½¿ç”¨ã„ãŸã—ã¾ã—ãŸã€‚
- [MySQLã§Nested Loopãªã‚¯ã‚¨ãƒªã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã©ã†è¾¿ã£ã¦ã„ã‚‹ã‹ - $shibayu36->blog;](https://blog.shibayu36.org/entry/2023/07/18/170000) 

å‚è€ƒã¨ãªã‚‹è¨˜äº‹ã‚’å…¬é–‹ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ã‚‚å…ƒè¨˜äº‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ Spanner å‘ã‘ã«æ›¸ãæ›ãˆãŸã‚‚ã®ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚

Spanner ã¯ Google æ¨™æº– SQL ã¨ PostgreSQL äº’æ›ã®äºŒé€šã‚Šã® SQL ãƒ¢ãƒ¼ãƒ‰ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¯ã«ä½¿ã„åˆ†ã‘ã‚‰ã‚Œã¾ã™ãŒã€æœ¬ç¨¿ã§ã¯ Google æ¨™æº– SQL ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

# ã‚¹ã‚­ãƒ¼ãƒ
ã‚¹ã‚­ãƒ¼ãƒã«é–¢ã—ã¦ã¯ã€å…ƒè¨˜äº‹ã®å®šç¾©ã‹ã‚‰å¤‰æ›´ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

ä¸»ã‚­ãƒ¼ã¯å…ƒã®å®šç¾©ã§ã¯ INTEGER ã® AUTO_INCREMENT ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ãŒã€UUID ã«å¤‰æ›´ã—ãŸãŸã‚å‹ã«ã¤ã„ã¦ã‚‚ STRING(36) ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚

Spanner ã§ã¯[ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–](https://cloud.google.com/spanner/docs/schema-and-data-model?hl=ja#create-interleaved-tables)ã¨ã„ã†æ¦‚å¿µãŒã‚ã‚Šã€ãƒ†ãƒ¼ãƒ–ãƒ«é–“ã§è¦ªå­é–¢ä¿‚ãŒå®šç¾©ã§ãã¾ã™ã€‚å­ãƒ†ãƒ¼ãƒ–ãƒ«ã¯è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ã®é–¢é€£ã™ã‚‹è¡Œã¨é€£ç¶šã—ãŸå ´æ‰€ã«é…ç½®ã•ã‚Œã‚‹ã“ã¨ã§ã€åŠ¹ç‡çš„ãªã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

ä»Šå›ã®å ´åˆã€users ã‚’è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦ã€follows ã¨ posts ã¯ä¸¡æ–¹ã‚’å­ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã®å­ãƒ†ãƒ¼ãƒ–ãƒ«ã¯è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸»ã‚­ãƒ¼(`user_id`)ã‚’å…ˆé ­ã«ã—ãŸè¤‡åˆä¸»ã‚­ãƒ¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```sql
CREATE TABLE `users` (
        `user_id` STRING(36) NOT NULL,
        `name` STRING(100) NOT NULL,
) PRIMARY KEY (`user_id`);

CREATE TABLE `follows` (
        `user_id` STRING(36) NOT NULL,
        `followee_id` STRING(36) NOT NULL,
) PRIMARY KEY (user_id, followee_id),
INTERLEAVE IN PARENT users ON DELETE CASCADE;

ALTER TABLE `follows` ADD FOREIGN KEY (followee_id) REFERENCES `users` (user_id);

CREATE TABLE `posts` (
        `user_id` STRING(36) NOT NULL,
        `post_id` STRING(36) NOT NULL,
        `body` STRING(MAX) NOT NULL,
        `posted_at` TIMESTAMP NOT NULL,
        `deleted` BOOL NOT NULL,
) PRIMARY KEY (`user_id`, post_id),
INTERLEAVE IN PARENT users ON DELETE CASCADE;

CREATE INDEX `idx_user_id_posted_at` ON `posts` (`user_id`, `deleted`, `posted_at` DESC), INTERLEAVE IN users;
```
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã®å®šç¾©ã«ã‚ˆã‚Šã€ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§(`follows`)ã¨ãƒã‚¹ãƒˆã—ãŸè¨˜äº‹(`posts`)ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªä½“ã®æƒ…å ±ã«ç¶šã„ã¦ç‰©ç†çš„ã«ã¾ã¨ã¾ã£ã¦é…ç½®ã•ã‚Œã¾ã™ã€‚ç‰©ç†çš„ã«ã¯ä»¥ä¸‹ã®å›³ã®ã‚ˆã†ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«ãªã‚Šã¾ã™ã€‚

![ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–æ™‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç‰©ç†ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ](/images/interleave_layout.png)

# ã‚¯ã‚¨ãƒª
ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´ã«ä¼´ã„ä¸€éƒ¨ã®ã‚«ãƒ©ãƒ åã¨å‹ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚ãã®ãŸã‚ã‚¯ã‚¨ãƒªãƒ¼ä¸­ã§ã®ã‚«ãƒ©ãƒ åã¨æ¡ä»¶å¥ã®å€¤ã‚’ã‚’å¤‰æ›´ã—ã¾ã—ãŸãŒã€ãã‚Œä»¥å¤–ã®éƒ¨åˆ†ã«ã¤ã„ã¦ã¯ãã®ã¾ã¾å®Ÿè¡Œå¯èƒ½ã§ã—ãŸã€‚

```sql
SELECT
  posts.post_id, posts.posted_at
FROM
  posts
JOIN
  follows
ON
  posts.user_id = follows.followee_id
WHERE
  follows.user_id = '07beb0ca-6263-4cc8-9e32-61a308d476b1'
  AND posts.deleted = FALSE
  AND posts.posted_at <= '2023-09-16 02:41:52.000'
ORDER BY
  posts.posted_at DESC
LIMIT
  20;
```

ã‚¯ã‚¨ãƒªãƒ¼ã®æ„å‘³ã¨ã—ã¦ã¯ã€ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼(`'07beb0ca-6263-4cc8-9e32-61a308d476b1'`)ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿è¨˜äº‹ã®ä¸€è¦§ã‚’å‰Šé™¤æ¸ˆã¿ã§ã¯ãªã(`posts.deleted = FALSE`)ã€ä¸€å®šã®æ—¥ä»˜ã‚ˆã‚Šã‚‚å‰ã®æŠ•ç¨¿æ—¥(`posts.posted_at <= '2023-09-16 02:41:52.000'`)ã¨ã„ã†æ¡ä»¶ã§å–å¾—ã—ã¦ã€æŠ•ç¨¿æ—¥ã®é™é †ã§å…ˆé ­20ä»¶ã‚’å–å¾—ã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

ä»¥é™ã®å†…å®¹ã¯ã“ã®ã‚¯ã‚¨ãƒªãƒ¼ã«ã¤ã„ã¦ã®å®Ÿè¡Œè¨ˆç”»ã‚’èª­ã¿è§£ãã¾ã™ã€‚

# å®Ÿè¡Œè¨ˆç”»ã®å–å¾—æ–¹æ³•
Spanner ã®å®Ÿè¡Œè¨ˆç”»ã‚’å–å¾—ã™ã‚‹ä¸»ãªæ–¹æ³•ã¯ã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¾ãŸã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰å–å¾—å¯èƒ½ã§ã™ã€‚å®šæœŸçš„ãªå–å¾—ã§ã‚ã‚Œã°ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œã‚‹ã“ã¨ã‚‚æœ‰åŠ¹ã§ã™ãŒã€[spanner-cli](https://github.com/cloudspannerecosystem/spanner-cli) ã§å¯¾è©±çš„ã«ã‚‚å–å¾—å¯èƒ½ã§ã™ã€‚

å®Ÿè¡Œè¨ˆç”»ã®è©³ç´°ã‚’ JSON å½¢å¼ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ gcloud ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰å–å¾—å¯èƒ½ãªä»–ã€ã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå¯èƒ½ã§ã™ã€‚JSON å½¢å¼ã¯æƒ…å ±é‡ãŒå¤šã„ã‚‚ã®ã®ã€äººé–“ãŒç›´æ¥èª­ã‚€ã«ã¯è¤‡é›‘ã§ã‚ã‚‹ãŸã‚ [apstndb](https://spanner-hacks.apstn.dev/) ã•ã‚“ä½œæˆã® [spannerplanviz](https://github.com/apstndb/spannerplanviz) ã§å¯è¦–åŒ–ã•ã‚Œã‚‹ã¨ä¾¿åˆ©ã§ã™ã€‚

# å®Ÿè¡Œè¨ˆç”»ã®è©³ç´°
## ã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å–å¾—ã—ãŸå®Ÿè¡Œè¨ˆç”»
ã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚¯ã‚¨ãƒªãƒ¼ã‚’å®Ÿè¡Œã—ã€ãã®ã€Œèª¬æ˜ã€ã‚¿ãƒ–ã‚’è¦‹ã‚‹ã¨å®Ÿè¡Œè¨ˆç”»ã‚’ã‚°ãƒ©ãƒ•åŒ–ã—ãŸã‚‚ã®ãŒè¦‹ãˆã¾ã™ã€‚

![ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã§ã®å®Ÿè¡Œè¨ˆç”»ã‚°ãƒ©ãƒ•](/images/plan_on_console.png)

## spanner-cli ã‹ã‚‰å–å¾—ã—ãŸå®Ÿè¡Œè¨ˆç”»
spanner-cli ã‹ã‚‰åŒã˜ã‚¯ã‚¨ãƒªãƒ¼ã«ã¤ã„ã¦ EXPLAIN ANALYZE(å®Ÿè¡Œè¨ˆç”»ã¨å®Ÿéš›ã®å®Ÿè¡Œæ™‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å–å¾—)ã‚’è¡Œã£ãŸçµæœãŒä»¥ä¸‹ã§ã™ã€‚
``` sql
spanner> EXPLAIN ANALYZE
      -> SELECT
      ->   posts.*
      -> FROM
      ->   posts
      -> JOIN
      ->   follows
      -> ON
      ->   posts.user_id = follows.followee_id
      -> WHERE
      ->   follows.user_id = '07beb0ca-6263-4cc8-9e32-61a308d476b1'
      ->   AND posts.deleted = FALSE
      ->   AND posts.posted_at <= '2023-09-16 02:41:52.000'
      -> ORDER BY
      ->   posts.posted_at DESC
      -> LIMIT
      ->   20;
+-----+---------------------------------------------------------------------------+---------------+------------+---------------+
| ID  | Query_Execution_Plan                                                      | Rows_Returned | Executions | Total_Latency |
+-----+---------------------------------------------------------------------------+---------------+------------+---------------+
|  *0 | Distributed Union (distribution_table: users, split_ranges_aligned: true) | 20            | 1          | 443.34 msecs  |
|   1 | +- Serialize Result                                                       | 20            | 1          | 443.32 msecs  |
|   2 |    +- Global Sort Limit                                                   | 20            | 1          | 443.31 msecs  |
|  *3 |       +- Distributed Cross Apply                                          | 60            | 1          | 443.26 msecs  |
|   4 |          +- [Input] Create Batch                                          |               |            |               |
|   5 |          |  +- Local Distributed Union                                    | 999           | 1          | 0.7 msecs     |
|   6 |          |     +- Compute Struct                                          | 999           | 1          | 0.62 msecs    |
|  *7 |          |        +- Filter Scan                                          |               |            |               |
|   8 |          |           +- Table Scan (Table: follows, scan_method: Scalar)  | 999           | 1          | 0.41 msecs    |
|  17 |          +- [Map] Local Sort Limit                                        | 60            | 3          | 798.73 msecs  |
|  18 |             +- Cross Apply                                                | 807909        | 3          | 751.36 msecs  |
|  19 |                +- [Input] KeyRangeAccumulator                             |               |            |               |
|  20 |                |  +- Batch Scan (Batch: $v2, scan_method: Scalar)         |               |            |               |
|  22 |                +- [Map] Local Distributed Union                           | 807909        | 999        | 707.34 msecs  |
| *23 |                   +- Filter Scan                                          |               |            |               |
|  24 |                      +- Table Scan (Table: posts, scan_method: Scalar)    | 807909        | 999        | 662.8 msecs   |
+-----+---------------------------------------------------------------------------+---------------+------------+---------------+
Predicates(identified by ID):
  0: Split Range: ($user_id_1 = '07beb0ca-6263-4cc8-9e32-61a308d476b1')
  3: Split Range: ($user_id = $followee_id)
  7: Seek Condition: ($user_id_1 = '07beb0ca-6263-4cc8-9e32-61a308d476b1')
 23: Seek Condition: ($user_id = $batched_followee_id)
     Residual Condition: (($deleted = false) AND ($posted_at <= timestamp (2023-09-16 02:41:52-07:00)))

20 rows in set (454.37 msecs)
timestamp:            2023-09-29T18:59:19.131112+09:00
cpu time:             833.31 msecs
rows scanned:         999999 rows
deleted rows scanned: 0 rows
optimizer version:    5
optimizer statistics: auto_20230927_10_45_18UTC

```
çµæœã¯å®Ÿè¡Œè¨ˆç”»ã®å„ã‚¹ãƒ†ãƒƒãƒ—ã®ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã†å‡¦ç†ãªã©ã§ã®æ¡ä»¶å¥ãŒã©ã®ã‚ˆã†ã«æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‹ã€ã‚¯ã‚¨ãƒªãƒ¼å…¨ä½“ã®è«¸æƒ…å ±ã®é †ã§å‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã®ã‚¯ã‚¨ãƒªãƒ¼ã¯ 99999 è¡Œã‚¹ã‚­ãƒ£ãƒ³ãŒè¡Œã‚ã‚Œ(rows scanned)ã€[ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³](https://cloud.google.com/spanner/docs/query-optimizer/versions?hl=ja)ã¯ 2023 å¹´ 10 æœˆåˆæ—¬æ™‚ç‚¹ã§ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚ã‚‹ 5 ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚ã‚ˆã‚Šæ–°ã—ã„ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 6 ã¯ç¾åœ¨é¸æŠå¯èƒ½ã¨ãªã£ã¦ãŠã‚Šã€ä»Šå¾Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒå¤‰æ›´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã¯ç¶™ç¶šçš„ã«æ”¹è‰¯ãŒç¶šã‘ã‚‰ã‚Œã¦ãŠã‚Šã€å®Ÿè¡Œè¨ˆç”»ã¯ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦å¤‰åŒ–ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®è¨­å®šã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å˜ä½ã§[ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™](https://cloud.google.com/spanner/docs/query-optimizer/manage-query-optimizer?hl=ja)ã€‚

## JSON å½¢å¼ã®å®Ÿè¡Œè¨ˆç”»ã‚’ã‚°ãƒ©ãƒ•åŒ–ã—ãŸã‚‚ã®
JSON å½¢å¼ã§å–å¾—ã—ãŸå®Ÿè¡Œè¨ˆç”»ã‚’ spannerplanviz ã§å¯è¦–åŒ–ã—ãŸã‚‚ã®ãŒä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

![spannerplanvizã§å¯è¦–åŒ–ã—ãŸã‚°ãƒ©ãƒ•](/images/plan_graph.webp)

éå¸¸ã«ç´°ã‹ã„æƒ…å ±ã¾ã§å‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯æœ€ã‚‚ç´°ã‹ã„å‡ºåŠ›ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ã‚‹ãŸã‚ã§é€šå¸¸ã¯ã“ã“ã¾ã§ç´°ã‹ã„æƒ…å ±ã¾ã§è¦‹ã‚‹å¿…è¦ã¯å¿…ãšã—ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚

# å®Ÿè¡Œè¨ˆç”»ã®èª­ã¿è§£ã
å®Ÿè¡Œè¨ˆç”»ã¯ä¸€è¦‹ã—ãŸã¨ã“ã‚éå¸¸ã«è¤‡é›‘ã«è¦‹ãˆã¾ã™ãŒã€å„ã‚¹ãƒ†ãƒƒãƒ—ãŒç´°ã‹ãè¡¨ç¾ã•ã‚Œã¦ã„ã‚‹ã ã‘ã§ä¸»è¦ãªå‡¦ç†ã¯ãã‚Œã»ã©è¤‡é›‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

å®Ÿè¡Œè¨ˆç”»ã¯å¤§ããåˆ†ã‘ã¦3ã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰æ§‹æˆã•ã‚Œã‚‹ã®ã§ã€ãã‚Œãã‚Œ A,B,C ã¨ã—ã¾ã™ã€‚

![å®Ÿè¡Œè¨ˆç”»ã‚°ãƒ©ãƒ•ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ã—ãŸå›³](/images/plan_groups.png)

ä»¥é™ã®èª¬æ˜ã§ã®å‡¦ç†æ™‚é–“ã¯ spanner-cli ã§å¾—ã‚‰ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆç‰ˆã§ã®çµæœã«åŸºã¥ãã¾ã™ã€‚
å®Ÿè¡Œç’°å¢ƒã¯ 1000 PU (1ãƒãƒ¼ãƒ‰)ã§ã™ãŒã€å®Ÿè¡Œã«æ›ã‹ã£ãŸæ™‚é–“ã«é–¢ã—ã¦ã¯å‚è€ƒç¨‹åº¦ã¨ã”ç†è§£ãã ã•ã„ã€‚

## ã‚°ãƒ«ãƒ¼ãƒ— A ã®å‡¦ç†å†…å®¹
ã‚°ãƒ«ãƒ¼ãƒ— A ã®æœ«ç«¯ã§ã¯ follows ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã™ã‚‹ã‚¹ã‚­ãƒ£ãƒ³([Table Scan](https://cloud.google.com/spanner/docs/query-execution-operators#scan) ã¨ [Filter Scan](https://cloud.google.com/spanner/docs/query-execution-operators#filter_scan))ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®å®Ÿè¡Œè¨ˆç”»ã§ã® 7 ã¨ 8 ã®è¡Œã§ã™ã€‚æŒ‡å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–ã£ã¦ãã‚‹å‡¦ç†ã§ã™ã€‚follows ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ user ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ç¯„å›²ã¯ç‰©ç†çš„ã«é€£ç¶šã—ãŸé ˜åŸŸã«ã‚ã‚Šã¾ã™ã€‚å‡¦ç†æ™‚é–“ã¯ 1ms ã»ã©ã§å®Ÿè¡Œå®Œäº†ã—ã¦ãŠã‚Šã€999è¡Œè¿”ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚¦ã‚§ãƒ–ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç‰ˆã®å®Ÿè¡Œè¨ˆç”»ã‚°ãƒ©ãƒ•ã§ã¯çœç•¥ã•ã‚Œã¦ã„ã¾ã™ãŒã€spannerplanviz ç‰ˆã§ã¯ [Create batch](https://cloud.google.com/spanner/docs/query-execution-operators?hl=ja#create_batch) ã§çµæœã‚’ $v2 ã«ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚ã“ã®çµæœãŒæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ã‚ã‚Œã¾ã™ã€‚

## ã‚°ãƒ«ãƒ¼ãƒ— B ã®å‡¦ç†å†…å®¹
ã‚°ãƒ«ãƒ¼ãƒ— B ã§ã¯å…ˆã®ã‚¹ãƒ†ãƒƒãƒ—ã§å¾—ã‚‰ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ä¸€è¦§($v2)ã«åŸºã¥ãã€å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® posts ã‚’é›†ã‚ã¦ã„ã¾ã™ã€‚ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ã®å®Ÿè¡Œè¨ˆç”»ã§ã¯17è¡Œç›®ã‹ã‚‰24è¡Œç›®ãŒãã‚Œã«ã‚ãŸã‚Šã¾ã™ã€‚å€‹åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® posts ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã«ç‰©ç†çš„ã«ã¾ã¨ã¾ã£ã¦é…ç½®ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€[Cross Apply](https://cloud.google.com/spanner/docs/query-execution-operators#cross-apply) ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ï¼ˆCross Apply ã¨ã¯ MySQL ãªã©ã® Nested Loop Join ã¨åŒæ§˜ã«ãƒ†ãƒ¼ãƒ–ãƒ«åŒå£«ã‚’çµåˆã™ã‚‹å‡¦ç†ã§ã™)ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã¯å€‹åˆ¥ã®ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯ã«è¡Œã‚ã‚Œã‚‹ãŸã‚ã€999 å›å®Ÿè¡Œã•ã‚Œæ¡ä»¶ã«é©åˆã™ã‚‹åˆè¨ˆ 80ä¸‡è¡Œã»ã©è¿”ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã¾ãŸã€ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã‚°ãƒ«ãƒ¼ãƒ— B ã®å‡¦ç†å…¨ä½“ãŒ 3ä¸¦åˆ—(concurrent)ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚ä¸¦åˆ—å‡¦ç†ã®å®Ÿè¡Œå˜ä½ã”ã¨ã«ã‚½ãƒ¼ãƒˆãŒè¡Œã‚ã‚Œã€LIMIT ã®æŒ‡å®šã«ã‚ˆã‚Šå„ã‚¹ãƒ—ãƒªãƒƒãƒˆã§é™é †ã§ã®ä¸Šä½ 20è¡Œã®çµæœãŒè¿”ã•ã‚Œã¾ã™ã€‚å…¨ä½“ã¨ã—ã¦ã¯ 60è¡Œã¨ãªã£ã¦ã„ã‚‹ã®ã¯ 3ä¸¦åˆ—é–“ã§ã®ãƒãƒ¼ã‚¸ãŒã“ã®æ®µéšã§ã¯è¡Œã‚ã‚Œã¦ã„ãªã„ãŸã‚ã§ã™ãŒã€å‡¦ç†é€”ä¸­ã§ LIMIT å¥ã«å¾“ã£ã¦ä»¶æ•°ã‚’å‰Šæ¸›å‡ºæ¥ã¦ã„ã‚‹ã®ã¯åŠ¹ç‡çš„ã¨ã„ãˆã‚‹ã§ã—ã‚‡ã†ã€‚

ã‚°ãƒ«ãƒ¼ãƒ— B ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ãŒå…¨ä½“ã®å‡¦ç†ä¸­ã§æœ€ã‚‚é•·ã„éƒ¨åˆ†ã§ã™ãŒã€ã‚¯ã‚¨ãƒªãƒ¼ã®å…¨ä½“ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· 468.75ms ã‚ˆã‚Šã‚‚é•·ã 807.6ms ã»ã©ã‹ã‹ã£ã¦ã„ã¾ã™ã€‚å…¨ä½“ã®å‡¦ç†æ™‚é–“ã‚ˆã‚Šã‚‚é•·ã„ã®ã¯ä¸¦åˆ—å®Ÿè¡Œã•ã‚Œã¦ãŠã‚Šã€3ä¸¦åˆ—ã§ã®å»¶ã¹æ™‚é–“ã¨ãªã£ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚å®Ÿéš›ã«ä½•ä¸¦è¡Œ(parallel)ã§ã•ã‚Œã‚‹ã‹ã¯ãã®æ™‚ç‚¹ã§ã®ãƒãƒ¼ãƒ‰æ•°ã‚„ç©ºãçŠ¶æ³ã«ã‚‚ä¾å­˜ã—ã¾ã™ã€‚

## ã‚°ãƒ«ãƒ¼ãƒ— C ã®å‡¦ç†å†…å®¹
ã‚°ãƒ«ãƒ¼ãƒ— C ã¯ [Distributed Cross Apply](https://cloud.google.com/blog/ja/products/databases/magic-distributed-joins-cloud-spanner)(ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ã®3è¡Œç›®)ã§ã‚°ãƒ«ãƒ¼ãƒ— A ãŒè¿”ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§ã¨ã‚°ãƒ«ãƒ¼ãƒ— B ã®å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¹ãƒˆã‚’çµåˆã™ã‚‹å‡¦ç†ã§ã™ã€‚ã‚°ãƒ«ãƒ¼ãƒ— B ã§ã® Cross Apply ã¨é•ã„ Distributed ãŒã¤ã„ã¦ã„ã‚‹ã®ã¯ã€ã‚°ãƒ«ãƒ¼ãƒ— B ã¨ã¯ç•°ãªã‚Šåˆ†æ•£ã—ãŸå‡¦ç†ã®çµæœã‚’é›†è¨ˆã™ã‚‹å†…å®¹ã§ã‚ã‚‹ãŸã‚ã§ã™ã€‚ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯å‰æ®µéšã§ä»¶æ•°ãŒ 60 ä»¶ã¾ã§å‰Šæ¸›ã•ã‚Œã¦ã„ãŸãŸã‚ã€å‡¦ç†æ™‚é–“ãŒå…¨ä½“ã®å ã‚ã‚‹å‰²åˆã¯å¤§ããã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å¯¾è±¡ã®ä»¶æ•°ãŒéå¸¸ã«å¤§ãã„å ´åˆã«ã¯ã€å¤šãã®æ™‚é–“ã‚’è¦ã™ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚

ãã®å¾Œã‚½ãƒ¼ãƒˆã§æœ€çµ‚çš„ãª LIMIT å¥ ã§ã®æŒ‡å®šé€šã‚Š 20ä»¶ã ã‘ã‚’è¿”ã—ã¾ã™ã€‚ã“ã“ã§ã®ã‚½ãƒ¼ãƒˆå¯¾è±¡ã¯ 60ä»¶ã‹ã‚‰ã®çµã‚Šè¾¼ã¿ã ã£ãŸãŸã‚ã€‚ã‚½ãƒ¼ãƒˆã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚‚ 0.1ms æœªæº€ã§çµ‚ã‚ã£ã¦ã„ã¾ã™ã€‚

# ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
ä»Šã¾ã§è¦‹ã¦ããŸå®Ÿè¡Œè¨ˆç”»ã§ã¯ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å…¨ãä½¿ã‚ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ã‚­ãƒ¼ãƒã®æ®µéšã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒªãƒ¼ãƒ–ã‚’è¡Œã†ãªã©ãƒ‡ãƒ¼ã‚¿ã®å±€æ‰€æ€§ã‚’é«˜ã‚ã¦ã„ãŸãŸã‚ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã§ã‚‚ãã‚Œãªã‚Šã®æ™‚é–“ã§å®Œäº†ã—ã¦ã„ã¾ã—ãŸã€‚å®Ÿè¡Œæ™‚é–“ã¸ã®è¦æ±‚æ¬¡ç¬¬ã§ã¯ãã®ã¾ã¾ã§ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ã†æ–¹æ³•ã‚’è€ƒãˆã¦ã¿ã¾ã™ã€‚

Spanner ã®[ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹](https://cloud.google.com/spanner/docs/secondary-indexes?hl=ja)ã¯ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«(ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ¤œç´¢å¯¾è±¡ã¨ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«)ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å¯¾è±¡ã‚«ãƒ©ãƒ ã¨ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸»ã‚­ãƒ¼ã‚’å†…å®¹ã¨ã—ãŸåˆ¥ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯æœ€çµ‚çµæœã¨ã—ã¦ posts ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨ã‚«ãƒ©ãƒ (`posts.*`)ã‚’è¦æ±‚ã™ã‚‹ãŸã‚ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¸ã®ã‚¹ã‚­ãƒ£ãƒ³ã®ã¿ã§ã¯å®Œçµã§ããšã€ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®çµåˆãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚ã“ã®å‡¦ç†ã¯ãã‚Œãªã‚Šã«é«˜ã‚³ã‚¹ãƒˆã§ã™ã€‚

ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã¿ã§å®Œçµã™ã‚‹ã«ã¯ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å«ã¾ã‚Œã‚‹ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸»ã‚­ãƒ¼(`posts.user_id, posts.post_id`)ã ã‘ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã‹ã€ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã® [STORING å¥](https://cloud.google.com/spanner/docs/secondary-indexes?hl=ja#storing-clause)ã§å¿…è¦ãªã‚«ãƒ©ãƒ ã‚’ã‚»ã‚«ãƒ³ãƒ€ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å«ã‚ã¦ã—ã¾ã†æ–¹æ³•ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

å‰è€…ã®æ–¹æ³•ã‚’è©¦ã—ãŸä¾‹ãŒä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
```sql
spanner> EXPLAIN ANALYZE
      -> SELECT
      ->   posts.post_id, posts.posted_at
      -> FROM
      ->   posts
      -> JOIN
      ->   follows
      -> ON
      ->   posts.user_id = follows.followee_id
      -> WHERE
      ->   follows.user_id = '07beb0ca-6263-4cc8-9e32-61a308d476b1'
      ->   AND posts.deleted = FALSE
      ->   AND posts.posted_at <= '2023-09-16 02:41:52.000'
      -> ORDER BY
      ->   posts.posted_at DESC
      -> LIMIT
      ->   20;
+-----+----------------------------------------------------------------------------------------+---------------+------------+---------------+
| ID  | Query_Execution_Plan                                                                   | Rows_Returned | Executions | Total_Latency |
+-----+----------------------------------------------------------------------------------------+---------------+------------+---------------+
|  *0 | Distributed Union (distribution_table: users, split_ranges_aligned: true)              | 20            | 1          | 677.27 msecs  |
|   1 | +- Serialize Result                                                                    | 20            | 1          | 677.26 msecs  |
|   2 |    +- Global Sort Limit                                                                | 20            | 1          | 677.25 msecs  |
|  *3 |       +- Distributed Cross Apply                                                       | 60            | 1          | 677.23 msecs  |
|   4 |          +- [Input] Create Batch                                                       |               |            |               |
|   5 |          |  +- Local Distributed Union                                                 | 999           | 1          | 0.75 msecs    |
|   6 |          |     +- Compute Struct                                                       | 999           | 1          | 0.69 msecs    |
|  *7 |          |        +- Filter Scan                                                       |               |            |               |
|   8 |          |           +- Table Scan (Table: follows, scan_method: Scalar)               | 999           | 1          | 0.48 msecs    |
|  17 |          +- [Map] Local Sort Limit                                                     | 60            | 3          | 1.37 secs     |
|  18 |             +- Cross Apply                                                             | 807909        | 3          | 1.32 secs     |
|  19 |                +- [Input] Batch Scan (Batch: $v2, scan_method: Scalar)                 | 999           | 3          | 0.88 msecs    |
|  21 |                +- [Map] Local Distributed Union                                        | 807909        | 999        | 1.27 secs     |
| *22 |                   +- Filter Scan (seekable_key_size: 3)                                | 807909        | 999        | 1.23 secs     |
|  23 |                      +- Index Scan (Index: idx_user_id_posted_at, scan_method: Scalar) | 807909        | 999        | 1.13 secs     |
+-----+----------------------------------------------------------------------------------------+---------------+------------+---------------+
Predicates(identified by ID):
  0: Split Range: ($user_id_1 = '07beb0ca-6263-4cc8-9e32-61a308d476b1')
  3: Split Range: (($deleted = false) AND ($user_id = $followee_id) AND ($posted_at <= timestamp (2023-09-16 02:41:52-07:00)))
  7: Seek Condition: ($user_id_1 = '07beb0ca-6263-4cc8-9e32-61a308d476b1')
 22: Seek Condition: (($user_id = $batched_followee_id) AND ($deleted = false)) AND ($posted_at <= timestamp (2023-09-16 02:41:52-07:00))

20 rows in set (686.86 msecs)
timestamp:            2023-09-29T19:00:57.297412+09:00
cpu time:             868.37 msecs
rows scanned:         808908 rows
deleted rows scanned: 0 rows
optimizer version:    5
optimizer statistics: auto_20230927_10_45_18UTC
 ```
23è¡Œç›®ãŒãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã§ã¯ãªãã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¹ã‚­ãƒ£ãƒ³(Index Scan)ã«ãªã£ã¦ã„ã‚‹ã®ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚ã—ã‹ã—ãªãŒã‚‰ã€å®Ÿè¡Œæ™‚é–“è‡ªä½“ã¯é€Ÿãã¯ãªã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ã‹ã‚‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ã«ãªã£ãŸã“ã¨ã§ã€ã‚¯ã‚¨ãƒªãƒ¼å…¨ä½“ã§ã®ã‚¹ã‚­ãƒ£ãƒ³è¡Œæ•°ãŒæ¸›ã£ã¦ã„ã‚‹(999999 è¡Œã‹ã‚‰808908 è¡Œã¸)ã“ã¨ã‹ã‚‰ã‚¹ã‚­ãƒ£ãƒ³ã®é€”ä¸­æ‰“ã¡åˆ‡ã‚ŠãŒå¯èƒ½ã¨ãªã£ãŸäº‹ãŒåˆ†ã‹ã‚Šã¾ã™ãŒã€æ‰“ã¡åˆ‡ã‚Šã¾ã§ã«ã‚¹ã‚­ãƒ£ãƒ³ã—ãŸè¡Œæ•°ãŒå¤šããƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ£ãƒ³æ¯”è¼ƒã—ã¦å‡¦ç†æ™‚é–“ã¯çŸ­ç¸®ã§ããªã‹ã£ãŸã‚ˆã†ã§ã™ã€‚ã‚ˆã‚Šé¸æŠåº¦ãŒé«˜ã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚„æ—©æœŸã«æ‰“ã¡åˆ‡ã‚ŠãŒå‡ºæ¥ã‚‹æ¡ä»¶å¥ã§ã‚ã‚Œã°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ã®æ–¹ãŒé«˜é€Ÿã«å‡¦ç†ã§ãã‚‹å¯èƒ½æ€§ã¯ã‚ã‚Šã¾ã™ã€‚

# ã¾ã¨ã‚
Spanner ã§ã®å®Ÿè¡Œè¨ˆç”»ã®å–å¾—ã¨ãã®å†…å®¹ã«ã¤ã„ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚’ãƒ™ãƒ¼ã‚¹ã«è§£èª¬ã„ãŸã—ã¾ã—ãŸã€‚JOIN ãŒå‡¦ç†ã•ã‚Œã‚‹æ§˜å­ãªã©ã®åŸºæœ¬çš„ãªã‚³ãƒ³ã‚»ãƒ—ãƒˆã«ã¤ã„ã¦ã¯å…±é€šã—ã¦ã„ã‚‹ã¨ã“ã‚ãŒè¦‹ã¦å–ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚ä¸€æ–¹ã§ã€å®Ÿè¡Œè¨ˆç”»ã®ä¸€éƒ¨ã«åˆ†æ•£ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç‰¹æœ‰ã®ä¸¦åˆ—å‡¦ç†ãªã©ã‚‚å‡ºç¾ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

å®Ÿè¡Œè¨ˆç”»ã¾ã§æ·±æ˜ã‚Šã™ã‚‹ã¨ãã«ã¯ã‚¯ã‚¨ãƒªãƒ¼ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„ã®ãŸã‚ã§ã‚ã‚‹ã“ã¨ãŒå¤šã„ã¨æ€ã„ã¾ã™ã€‚ãã®å ´åˆã€æ™‚é–“ãŒæ›ã‹ã£ã¦ã„ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã‚„å¤šãã®è¡Œæ•°ã‚’è¿”ã—ã¦ã„ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã«ç€ç›®ã—ã¦åŠ¹ç‡åŒ–ã—ã¦ã„ãã¨ã„ã†æµã‚Œã¯ RDBMS ã§ã®ãƒã‚¦ãƒã‚¦ãŒæµç”¨å¯èƒ½ã§ã—ã‚‡ã†ã€‚

ã‚ˆã Spanner ãƒ©ã‚¤ãƒ•ã‚’

# å‚è€ƒè³‡æ–™
- https://engineering.mercari.com/blog/entry/20201210-cloud-spanner-query-plan/
- https://cloud.google.com/spanner/docs/tune-query-with-visualizer?hl=ja
- https://engineering.dena.com/blog/2020/07/spanner-secondary-index/
- https://spanner-hacks.apstn.dev/operators/
