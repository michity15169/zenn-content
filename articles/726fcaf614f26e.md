---
title: "Cloud Spanner の実行計画を読み解く"
emoji: "💬"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["cloudspanner","spanner","gcp"]
published: false
---
# 概要
Cloud Spanner はスケールアウトする分散データベースとしての特性がありますが、一般的な RDBMS と同じく SQL を実行することができます。
SQL の実行時には実行計画を立てて、実データにアクセスを行います。
実行計画の内容は分散データベース特有の概念も含まれている場合もありますが、基本的なコンセプトは共通する部分も多くあります。
本記事では Cloud Spanner でのクエリーの実行計画についての実例をもとにその内容を読み解きます。

対象とするスキーマ及び SQL は以下の MySQL を対象にした記事の内容を Cloud Spanner 向けに読み換えた物を使用いたしました。
[MySQLでNested Loopなクエリはインデックスをどう辿っているか - $shibayu36->blog;](https://blog.shibayu36.org/entry/2023/07/18/170000)
素晴らしい記事を公開いただきありがとうございます。

# スキーマ
スキーマに関しては、元記事の定義から変更点があります。

主キーは元の定義では INTEGER の AUTO_INCREMENT として定義されていますが、UUID に変更したため型についても STRING(36) に変更してあります。

Cloud Spanner では[インターリーブ](https://cloud.google.com/spanner/docs/schema-and-data-model?hl=ja#create-interleaved-tables)という概念があり、テーブル間で親子関係が定義できます。
子テーブルは親テーブルの関連する行と連続した場所に配置されることで、効率的なアクセスが可能となります。

今回の場合、users を親テーブルとして、follows と posts は子テーブルとしました。
インターリーブの子テーブルは親テーブルの主キー(user_id)を先頭にした複合主キーである必要があります。
これによって、特定のユーザーがフォローしているユーザーの一覧(follows)とポストした記事(posts)はユーザー自体の情報に続いて物理的にまとまって配置されます。

```sql
CREATE TABLE `users` (
        `user_id` STRING(36) NOT NULL,
        `name` STRING(100) NOT NULL,
) PRIMARY KEY (`user_id`);

CREATE TABLE `follows` (
        `user_id` STRING(36) NOT NULL,
        `followee_id` STRING(36) NOT NULL,
) PRIMARY KEY (user_id, followee_id),
INTERLEAVE IN PARENT users ON DELETE CASCADE;

CREATE TABLE `posts` (
        `user_id` STRING(36) NOT NULL,
        `post_id` STRING(36) NOT NULL,
        `body` STRING(MAX) NOT NULL,
        `posted_at` TIMESTAMP NOT NULL,
        `deleted` BOOL NOT NULL,
) PRIMARY KEY (`user_id`, post_id),
INTERLEAVE IN PARENT users ON DELETE CASCADE;

CREATE INDEX `idx_user_id_posted_at` ON `posts` (`user_id`, `posted_at` ), INTERLEAVE IN users;

ALTER TABLE `follows` ADD FOREIGN KEY (followee_id) REFERENCES `users` (user_id);
```
# クエリ



# 実行計画の取得方法
Cloud Spanner の実行計画を取得する主な方法はウェブコンソールまたはクライアントライブラリから取得可能です。
定期的な取得であればクライアントライブラリを使ってクライアントを作ることも有効ですが、[spanner-cli](https://github.com/cloudspannerecosystem/spanner-cli) で対話的にも取得可能です。

# 実行計画の読み解き
## マシングループ
## 
