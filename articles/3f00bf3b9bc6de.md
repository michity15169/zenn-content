---
title: "Cloud Spanner の運用について"
emoji: "🔧"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["cloudspanner","spanner","gcp"]
published: false
---
# はじめに
# バックアップ
# ポイントインタイムリカバリ(PITR)
PITR とはデータベースの内容を特定の時刻に戻すという機能です。
アプリケーションの誤動作やオペレーションミスによるデータ破損など、論理障害への対応で利用されることが多いと思われます。

一般的な RDBMS ではバックアップとトランザクションログ(binlog や WAL、アーカイブログ)と組み合わせて、稼働中のデータベースとは別にリストア先のインスタンスを作られることが多いかと思います。これに対して Cloud Spanner の PITR の考え方は少し違います。


# 断片化(fragment)対策
多くの RDBMS ではセカンダリインデックスについて作成後に追記・削除・更新を繰り返すとレイアウトが断片化を起こしパフォーマンス低下を招きます。この対策として、定期的なインデックスのメンテナンスを行う必要があります。

Cloud Spanner ではこのような明示的な操作は不要です。

Cloud Spanner では [LSM-Tree](https://en.wikipedia.org/wiki/Log-structured_merge-tree) と呼ばれるデータ構造を使っています。このデータ構造では追記はもちろん、削除・更新もその場(in-place)での書き換えではなく追記として実施されます。そのためデータファイルが歯抜けになり断片化するという動作が原理的に発生しません。

断片化に近い事象としては、大量のデータを一気にロードしたり削除したときが考えられます。先程の説明の通りこれらの操作は追記によって実現されます。もちろん削除操作を追記しただけではデータの占有サイズが大きくなる一方であるため、バックグラウンドタスクとしてコンパクション(Compaction)が実施されます。これによりデータが再編成されます。コンパクションの操作はシステムタスクとして実装されており、[中間の優先度を持っています](https://cloud.google.com/spanner/docs/cpu-utilization?hl=ja#task-priority)。そのため、大量のデータ操作をしてからある程度の時間をおいてシステムタスクが CPU 時間を使用する様子が観測されることがあります。ある意味定常的に詰め直しが発生しているとも言えるでしょう。この仕組みによってデータベース管理の一環として定期的なインデックスの再編成は必要ありません。

# バルクロード

# 実行計画

# サイジング

# モニタリング
## CPU 使用率
## レイテンシ
## Slow query log
## キャッシュヒット率
## ログ
## コネクション数


