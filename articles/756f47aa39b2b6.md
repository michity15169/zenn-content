---
title: "Cloud Spanner でのタグ付けのススメ"
emoji: "🏷"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["cloudspanner","spanner","gcp"]
published: false
---
# tl;dr

- Spanner でリクエストタグをつけておくとパフォーマンスモニタリングのときに便利
- タグの長さに制限があるので付け方にコツがあります

# 概要
Cloud Spanner ではトランザクションやリクエストにタグをつけることができます。

# タグの付け方

# タグの効果


# 注意点
## 長さの上限
タグに指定出来る文字列ははASCII文字のみで50文字までという[制限があります](https://cloud.google.com/spanner/docs/introspection/troubleshooting-with-tags?hl=ja#limitations)。

タグとしてソースコードのフルパスと行数などを指定すると制限を超過する場合があります。制限を超過すると切り詰められるため、エラーとなるわけでは有りませんがリクエストを識別するという目的を達成できない可能性があります。

長さの制限内でリクエスト発行元のコード上での部位を特定できる粒度で指定いただくのがよいでしょう。例えば、ユーザーアクション起因で発行されるクエリの場合はそのユーザーアクション名を含めるなど。

## 対応しているドライバ
Cloud Spanner へアクセスする方法はクライアントライブラリ、ORMとフレームワークドライバ、RPC API、REST APIの4通りあります。クライアントライブラリは Spanner 用に作られているだけあって[主な機能をすべて網羅しております](https://cloud.google.com/spanner/docs/api-libraries-overview?hl=ja#client-support)。

一方で、各言語の提供する DB アクセス共通化の仕組みやフレームワーク(例えば、Active Record や Hibernate など)で動作するドライバは[いくつかの機能制限があります](https://cloud.google.com/spanner/docs/drivers-overview?hl=ja#drivers_and_orms)。リクエストタグ付けについてはいくつかのフレームワークドライバでサポートされていません。

具体例として Go 言語の database/sql へのドライバはこの記事で紹介しているリクエストへのタグ付けにそのままでは対応しておりません。database/sql のドライバは Spanner クライアントライブラリへのラッパとして実装しているため、元のドライバインターフェイスで設定を指定することは[可能ですが](https://github.com/googleapis/go-sql-spanner/blob/main/docs/limitations.rst)、ややスマートさに欠けます。各ドライバでどのような制限があるか、回避策の有無などについてはドライバのマニュアルをご参照ください。

# 参考情報
- [リクエスト タグとトランザクション タグによるトラブルシューティング](https://cloud.google.com/spanner/docs/introspection/troubleshooting-with-tags?hl=ja)
